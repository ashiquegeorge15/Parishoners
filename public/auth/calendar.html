<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Church Calendar - St Thomas Church</title>
  <link rel="stylesheet" href="calendar.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .event-dot {
      height: 8px;
      width: 8px;
      background-color: #4a90e2;
      border-radius: 50%;
      display: inline-block;
      margin-left: 4px;
    }
    
    .event-list {
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    
    .event-item {
      background-color: white;
      border-left: 4px solid #4a90e2;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .event-item.worship {
      border-left-color: #28a745;
    }
    
    .event-item.meeting {
      border-left-color: #ffc107;
    }
    
    .event-item.celebration {
      border-left-color: #dc3545;
    }
    
    .event-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .event-date {
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .active {
      position: relative;
    }
    
    .active.has-events::after {
      content: "";
      position: absolute;
      bottom: 3px;
      left: 50%;
      transform: translateX(-50%);
      height: 4px;
      width: 4px;
      background-color: #4a90e2;
      border-radius: 50%;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #6c757d;
    }
  </style>
</head>

<body>
  <div class="TopOptions">
    <div class="name"> <img src="img/logo/marthoma-seeklogo.svg" alt="" id="churchLogo"> St Thomas Church</div>
    <div class="TopBar">
      <ul>
        <li><a href="../index.html">Home</a></li>
        <li><a href="../donations.html">Donate</a></li>
        <li><a href="../index.html#contact">Contact</a></li>
        <li><a href="../login.html">Login</a></li>
      </ul>
    </div>
  </div>

  <div class="container mt-4">
    <h1 class="text-center mb-4">Church Events Calendar</h1>
    
    <div class="row">
      <div class="col-md-8">
        <div class="calendar-container">
          <div class="month">
            <ul>
              <li class="prev" id="prevMonth">&#10094;</li>
              <li class="next" id="nextMonth">&#10095;</li>
              <li id="currentMonthYear">
                August<br>
                <span style="font-size:18px">2021</span>
              </li>
            </ul>
          </div>

          <ul class="weekdays">
            <li>Su</li>
            <li>Mo</li>
            <li>Tu</li>
            <li>We</li>
            <li>Th</li>
            <li>Fr</li>
            <li>Sa</li>
          </ul>

          <ul class="days" id="calendarDays">
            <!-- Days will be generated by JavaScript -->
            <div class="loading">Loading calendar...</div>
          </ul>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="event-list">
          <h3>Upcoming Events</h3>
          <div id="upcomingEvents">
            <div class="loading">Loading events...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
  
  <!-- Calendar Functions -->
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDyqAiultYZzwcoRfQhNKRiCG3DuEBEsd8",
      authDomain: "backendlogsign.firebaseapp.com",
      databaseURL: "https://backendlogsign-default-rtdb.firebaseio.com",
      projectId: "backendlogsign",
      storageBucket: "backendlogsign.appspot.com",
      messagingSenderId: "1039275246750",
      appId: "1:1039275246750:web:ee61d0b254a2697a3e278f",
      measurementId: "G-C9R69XEVH7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Calendar variables
    let currentDate = new Date();
    let events = [];
    
    // DOM elements
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthYear = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const upcomingEventsElement = document.getElementById('upcomingEvents');
    
    // Event listeners
    prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
    nextMonthBtn.addEventListener('click', () => navigateMonth(1));
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      fetchEvents();
    });
    
    // Fetch events from Firestore
    function fetchEvents() {
      calendarDays.innerHTML = '<div class="loading">Loading calendar...</div>';
      upcomingEventsElement.innerHTML = '<div class="loading">Loading events...</div>';
      
      db.collection('events')
        .orderBy('date', 'asc')
        .get()
        .then((querySnapshot) => {
          events = [];
          querySnapshot.forEach((doc) => {
            const eventData = doc.data();
            // Safely convert date field to JavaScript Date object
            let eventDate;
            if (eventData.date) {
              if (eventData.date.toDate) {
                // It's a Firestore timestamp
                eventDate = eventData.date.toDate();
              } else if (eventData.date.seconds) {
                // It's a Firestore timestamp-like object
                eventDate = new Date(eventData.date.seconds * 1000);
              } else if (typeof eventData.date === 'string') {
                // It's a date string
                eventDate = new Date(eventData.date);
              } else if (typeof eventData.date === 'number') {
                // It's a timestamp number
                eventDate = new Date(eventData.date);
              } else {
                console.warn('Unknown date format for event:', doc.id);
                eventDate = new Date(); // Fallback to current date
              }
            } else {
              console.warn('Missing date for event:', doc.id);
              eventDate = new Date(); // Fallback to current date
            }

            // Safely convert time field if it exists
            let eventTime = null;
            if (eventData.time) {
              if (eventData.time.toDate) {
                eventTime = eventData.time.toDate();
              } else if (eventData.time.seconds) {
                eventTime = new Date(eventData.time.seconds * 1000);
              } else if (typeof eventData.time === 'string') {
                eventTime = new Date(eventData.time);
              } else if (typeof eventData.time === 'number') {
                eventTime = new Date(eventData.time);
              }
            }

            events.push({
              id: doc.id,
              title: eventData.title || 'Untitled Event',
              date: eventDate,
              time: eventTime,
              isAllDay: eventData.isAllDay || false,
              location: eventData.location || '',
              description: eventData.description || '',
              category: eventData.category || 'other'
            });
          });
          
          renderCalendar();
          renderUpcomingEvents();
        })
        .catch((error) => {
          console.error('Error fetching events: ', error);
          calendarDays.innerHTML = '<div class="loading">Error loading calendar</div>';
          upcomingEventsElement.innerHTML = '<div class="loading">Error loading events</div>';
        });
    }
    
    // Render calendar
    function renderCalendar() {
      // Update month and year display
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      currentMonthYear.innerHTML = `
        ${monthNames[currentDate.getMonth()]}<br>
        <span style="font-size:18px">${currentDate.getFullYear()}</span>
      `;
      
      // Clear previous days
      calendarDays.innerHTML = '';
      
      // Get first day of month and last day of month
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      
      // Create empty cells for days before start of month
      const firstDayIndex = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
      for (let i = 0; i < firstDayIndex; i++) {
        const li = document.createElement('li');
        li.innerHTML = '';
        calendarDays.appendChild(li);
      }
      
      // Create cells for days in month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const li = document.createElement('li');
        
        // Check if current date
        const dateToCheck = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        const today = new Date();
        const isToday = dateToCheck.getDate() === today.getDate() && 
                      dateToCheck.getMonth() === today.getMonth() && 
                      dateToCheck.getFullYear() === today.getFullYear();
        
        // Check if date has events
        const hasEvents = events.some(event => {
          const eventDate = new Date(event.date);
          return eventDate.getDate() === dateToCheck.getDate() && 
                eventDate.getMonth() === dateToCheck.getMonth() && 
                eventDate.getFullYear() === dateToCheck.getFullYear();
        });
        
        // Set HTML content
        if (isToday) {
          li.innerHTML = `<span class="active ${hasEvents ? 'has-events' : ''}">${day}</span>`;
        } else {
          li.innerHTML = hasEvents ? `${day} <span class="event-dot"></span>` : day;
        }
        
        // Add click event to view day's events
        if (hasEvents) {
          li.addEventListener('click', () => {
            showDayEvents(dateToCheck);
          });
          li.style.cursor = 'pointer';
        }
        
        calendarDays.appendChild(li);
      }
    }
    
    // Show day events
    function showDayEvents(date) {
      const dayEvents = events.filter(event => {
        const eventDate = new Date(event.date);
        return eventDate.getDate() === date.getDate() && 
               eventDate.getMonth() === date.getMonth() && 
               eventDate.getFullYear() === date.getFullYear();
      });
      
      const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      let html = `<h4>${formattedDate}</h4>`;
      
      if (dayEvents.length === 0) {
        html += '<p>No events scheduled for this day.</p>';
      } else {
        dayEvents.forEach(event => {
          html += createEventItemHTML(event);
        });
      }
      
      upcomingEventsElement.innerHTML = html;
    }
    
    // Render upcoming events
    function renderUpcomingEvents() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Get events from today onwards
      const upcomingEvents = events.filter(event => {
        const eventDate = new Date(event.date);
        eventDate.setHours(0, 0, 0, 0);
        return eventDate >= today;
      }).slice(0, 5); // Limit to 5 upcoming events
      
      let html = '';
      
      if (upcomingEvents.length === 0) {
        html = '<p>No upcoming events scheduled.</p>';
      } else {
        upcomingEvents.forEach(event => {
          html += createEventItemHTML(event);
        });
      }
      
      upcomingEventsElement.innerHTML = html;
    }
    
    // Create HTML for a single event item
    function createEventItemHTML(event) {
      const eventDate = new Date(event.date);
      const formattedDate = eventDate.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric' 
      });
      
      const formattedTime = event.time ? new Date(event.time).toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      }) : (event.isAllDay ? 'All day' : '');
      
      return `
        <div class="event-item ${event.category}">
          <div class="event-title">${event.title}</div>
          <div class="event-date">
            <i class="fas fa-calendar-alt"></i> ${formattedDate}
            ${formattedTime ? `<span><i class="fas fa-clock"></i> ${formattedTime}</span>` : ''}
          </div>
          ${event.location ? `<div class="event-location"><i class="fas fa-map-marker-alt"></i> ${event.location}</div>` : ''}
        </div>
      `;
    }
    
    // Navigate to previous/next month
    function navigateMonth(direction) {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + direction, 1);
      renderCalendar();
    }
  </script>
</body>

</html>